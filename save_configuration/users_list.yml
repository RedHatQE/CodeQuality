---
- name: get users list
  uri:
    url: "{{ sonar_url }}/{{ users_list_api }}"
    user: '{{ sonar_username }}'
    password: '{{ sonar_password  }}'
    body_format: json
    method: GET
    status_code: 200
    force_basic_auth: yes
  register: response

- name:  extract needed configuration
  debug:
    msg: 'login: {{ item.login }}, name: {{ item.name }}'
  loop: "{{ response.json.users }}"
  register: result

- name: users topic
  lineinfile:
    path: '{{ configuration_file }}'
    line: '#################Sonar Users#################'

- name: write users configuration
  lineinfile:
    path: '{{ configuration_file }}'
    line: '{{ item.msg }}'
  loop: "{{ result | json_query('results[*]') }}"
